== OpenID Connect (OIDC)

=== Was ist OIDC?

OpenID Connect ist ein Authentifizierungsprotokoll und eine Erweiterung des OAuth 2.0 Standards. Es ermöglicht Clients die Überprüfung der Identität des Endbenutzers auf der Grundlage der von einem Autorisierungsserver durchgeführten Authentifizierung, sowie den Erhalt grundlegender Profilinformationen über den Endbenutzer in einer interoperablen und REST-ähnlichen Schnittstelle. Mit OpenID Connect können Clients aller Art, einschließlich webbasierter, mobiler und JavaScript-Clients, Informationen über authentifizierte Sitzungen und Endbenutzer anfordern und empfangen.

Bei einer OpenID-Connect-Anfrage wird der Benutzer an einen Identitätsanbieter, wie zb. Google oder Facebook weitergeleitet, der die angeforderten Informationen authentifiziert und autorisiert und dann mit einem ID-Token und optional einem Zugriffstoken an die anfordernde Anwendung (zb. einer App) zurückgeschickt.

NOTE: *Authentifizierung:* _"Bist du das wirklich?"_ Authentifizierung ist die Möglichkeit, zu beweisen, dass ein Benutzer oder eine Anwendung wirklich die Person oder die Anwendung ist, welche die Anwendung beansprucht.

NOTE: *Autorisierung:* _"Bist du berechtigt das zu tun?"_ Autorisierung bezeichnet das initiale Zuweisen und das wiederholt einleitende Überprüfen von Zugriffsrechten mittels spezieller Methoden bezüglich interessierter Systemnutzer zu Daten und zu Diensten.

*UseCase:* zb. SSO (Single Sign-On) für Konsumenten Apps

=== Erweiterung des OAuth 2.0 Authorization Request

Ursprünglich ist OIDC eine Erweiterung des OAuth 2.0 Standards um die Authentifizierung des Nutzers. Dabei wird der *OAuth 2.0 Authorization Request* um den Parameter *Scope* erweitert. Hiermit kann festgelegt werden, auf welche Informationen der Client vom Nutzer zugreifen darf. Diese Informationen werden in Form eines *Claims* zurückgesendet. 

==== Scope

Scope ist ein Konzept in OIDC, welches die Zugriffsberechtigungen eines Access Tokens auf bestimmte Ressourcen zb. die eines Nutzers beschreibt. Es ist eine Liste von Claims, die angeben, für welche Bereiche eine Anwendung berechtigt ist, wenn diese eine Anfrage an eine Ressource stellt.

Ein Beispiel für den Einsatz von Scope könnte sein, dass eine Anwendung, die auf Gesundheitsdaten zugreifen möchte, über einen Access Token verfügt, welches "read:patient" berechtigt. Das bedeutet, dass sie Zugriff auf die Patientendaten hat, aber keinen Zugriff auf administrative Daten oder andere Daten, die nicht Teil des _"read:patient"_ Scopes sind.

In OIDC werden Scopes verwendet, um die Zugriffsberechtigungen für Benutzerdaten und -ressourcen zu beschreiben und zu regeln. Dies hilft, sicherzustellen, dass Benutzerdaten geschützt bleiben und, dass Anwendungen nur die Berechtigungen erhalten, die sie zur Ausführung ihrer Funktionen benötigen. Häufig stimmen Nutzer jedoch bei der Anmeldung zu, dass Anwendungen alle ihre Nutzerdaten lesen und verarbeiten dürfen, ohne sich dessen bewusst zu sein. Dadurch entsteht ein Verlust der Datenkontrolle seitens des Endnutzers.

==== Claims

Claims sind in diesem Kontext Aussagen über eine Person oder eine Sache, die in einem Token enthalten sind. Sie beschreiben Informationen, die einem Empfänger des Tokens (häufig der Anwendung/Webseite/Relying Party) bekannt gegeben werden sollen. In OIDC werden Claims verwendet, um Benutzerdaten und Informationen über die Authentifizierung und Autorisierung bereitzustellen.

Ein Beispiel für ein Claim könnte sein:

    "name": "Jane Doe"
    "email": "janedoe@example.com"
    "birthdate": "0000-10-31"

In diesem Beispiel beschreiben die Claims den vollständigen Namen, die E-Mail-Adresse und das Geburtsdatum einer Person. Diese Claims können in einem OIDC-Token enthalten sein und an eine Anwendung weitergegeben werden, um die Identität eines Benutzers zu bestätigen und dessen Daten zu verwenden. Es hängt von der Implementierung und Konfiguration ab, welche Claims in einem Token enthalten sind.

==== ID-Token

Um einen Nutzer zu identifizieren, wird ein ID-Token verwendet. Es handelt sich hierbei um ein signiertes und optional verschlüsseltes Datenelement, welches *Informationen über den Benutzer* enthält, wie z.B. den Namen, die E-Mail-Adresse und andere identifizierende Merkmale. ID-Tokens werden zur Authentifizierung des Benutzers für eine einmalige Sitzung verwendet.

Ein Beispiel für einen ID-Token im JSON-Format:
----
{
  "iss": "http://my-domain.auth0.com",
  "sub": "auth0|123456",
  "aud": "my_client_id",
  "exp": 1311281970,
  "iat": 1311280970,
  "name": "Jane Doe",
  "given_name": "Jane",
  "family_name": "Doe",
  "gender": "female",
  "birthdate": "0000-10-31",
  "email": "janedoe@example.com",
  "picture": "http://example.com/janedoe/me.jpg"
}
----

Diese Felder bezeichnen die Claims im Kontext von OIDC. Die einzelnen Teilnehmer werden im nächsten Abschnitt nochmal genauer erläutert.

* *"iss" (Issuer):* Identifiziert die Partei, welche den Token ausgestellt hat (OpenID Provider und/oder Identity Provider)

* *"sub" (Subject):* Eindeutige Identifikation des Benutzers, für den der Token ausgestellt wurde (Resource Owner)

* *"aud" (Audience):* Empfänger des Tokens (Reyling Partie)

* *"exp" (Expiration Time):* Ablaufdatum des Tokens

* *"iat" (Issued At):* Zeitpunkt, zu dem der Token ausgestellt wurde

und weitere Informationen über den Benutzer.

==== Access Token

Um Zugriff auf die API oder weitere Ressourcen zu erhalten, wird ein Zugriffstoken verwendet. Es handelt sich dabei um ein signiertes und optional verschlüsseltes Datenelement, welches *Informationen über den Client und den Ressourcenserver*, sowie eine *Berechtigungserteilung* enthält. Zugriffstoken werden für den Zugriff auf geschützte Ressourcen im Namen eines autorisierten Benutzers verwendet.

Ein Beispiel für einen Access Token im JSON-Format
----
{
  "iss": "https://my-domain.auth0.com/",
  "sub": "auth0|123456",
  "aud": [
    "https://example.com/health-api",
    "https://my-domain.auth0.com/userinfo"
  ],
  "azp": "my_client_id",
  "exp": 1311281970,
  "iat": 1311280970,
  "scope": "openid profile read:patients"
}
----

Interessant ist vor allem der letzte Parameter *Scope*, welcher die wesentliche Erweiterung von OAuth zu OIDC darstellt und das vorherige Beispiel nochmals aufgreift. In diesem Beispiel wird folgendes Recht zum Lesen von Patientendaten vergeben:

    read:patients -> erlaubt den Zugriff auf Patientendaten

=== Die Teilnehmer

In OIDC werden 4 Teilnehmer benötigt, um einen Authentifizierungsprozess durchzuführen. Diese Teinehmer sind der Identity Provider (IdP), die Relying Party (RP), der OpenID Provider (OP) und der Resource Owner (RO).

* *Identity Provider (IdP):* Ein IdP ist ein Dienst (zb. Google oder Facebook), welcher Benutzer authentifiziert und nach erfolgreicher Authentifzierung einen Identitäts-Token ausstellt. Der IdP ist für die sichere Authentifizierung von Benutzern, sowie für die Verwaltung und den Schutz ihrer Identitäten verantwortlich. Die Nutzerdaten werden dabei auf den Servern des IdP's gesichert und gespeichert.

* *Relying Party (RP):* Ein RP ist ein Dienst oder Client (zb. eine App), der sich auf den IdP verlässt, um seine Benutzer authentifizieren zu können. Der RP ist dafür verantwortlich, die Identitäts-Token vom IdP zu verbrauchen, um seine Benutzer zu identifizieren.

NOTE: *Identifizierung:* _"Wer bist du?"_ Identifikation ist die Fähigkeit, eindeutig einen Benutzer eines Systems oder einer Anwendung zu identifizieren, welche im System aufgeführt wird.

* *OpenID Provider (OP):* Ein OP ist ein Dienst, welcher eine OpenID Connect-Schnittstelle zwischen dem IdP und der RP bereitstellt. Der OP ist verantwortlich für die sichere Bereitstellung der notwendigen Protokoll- und Kommunikationsinfrastruktur, um den Authentifizierungsprozess zu erleichtern.

* *Resource Owner (RO):* Ein RO ist die Entität, welche den Zugriff auf eine geschützte Ressource (zb. Personeninformationen) gewährt, z.B. ein Endnutzer. Der RO ist für die Autorisierung des Zugriffs auf die Ressource verantwortlich und kann entweder der Endbenutzer selbst oder eine Entität sein, der die Autorität übertragen wurde, im Namen des Endbenutzers handeln zu dürfen.

==== Einfacher Beispiel Ablauf

Der Ablauf des OIDC-Protokolls wird im Folgenden aus einfacher Sicht der Teilnehmer dargestellt, ohne in die Tiefe technischer Details zu gehen. 

image::./2_OIDC/img/Ablauf_OIDC.png[]

. Ein Endbenutzer (Resource Owner) besucht eine Webseite (Relying Party), welche OpenID Connect unterstützt und klickt zb. auf eine Schaltfläche "Anmelden über [IdP]".

. Die Webseite (auch Client genannt) leitet den Endbenutzer an den OpenID Provider (OP), häufig gleichzeitig auch den Identity Provider, mit einer Anfrage zur Authentifizierung des Benutzers weiter.

. Der Identity Provider authentifiziert den Benutzer, indem er ihn auffordert, seinen Benutzernamen und sein Passwort einzugeben. Dabei müssen die Daten die angefordert werden, bereits vor der Abfrage deklariert sein.

. Nach erfolgreicher Authentifizierung sendet der OpenID Provider eine Authentifizierungsantwort an die Reyling Party mit einem ID-Token und einem Access Token zurück.

. Die Relying Party überprüft den ID-Token, um sicherzustellen, dass dieser gültig ist und dass der Benutzer derjenige ist, der er vorgibt zu sein.

. Die Relying Party kann nun das Access Token verwenden, um im Namen des Benutzers API-Aufrufe an den OpenID Provider zu tätigen.

. Die Webseite kann dadurch dem Nutzer ein personalisiertes Erlebnis auf der Webseite auf Grundlagen seiner persönlichen Daten bieten.

=== Einordnung von OIDC

OIDC ist der derzeitige Standard für die Identifizierung, Authentifizierung und Autorisierung im Web 2.0. Dabei treten gewisse Herausforderungen und Bedenken auf, die im ersten Abschnitt bereits erläutert wurden.

Im nächsten Abschnitt wollen wir das Konzept von SSI genauer erläutern und kurz auf die technischen Grundrahmenbedingungen eingehen. SSI kann durch verschiedene Methoden und Protokolle implementiert werden. Eines der am häufigsten verwendeten Protokolle ist dabei DIDComm, welches wir später nochmal konkreter im Vergleich zu OIDC betrachten werden.
